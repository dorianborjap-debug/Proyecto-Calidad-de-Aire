<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 Data Dashboard</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f4f9}
    .container{max-width:900px;margin:50px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1)}
    .login-form{display:block;}       /* ← visible al inicio */
    .dashboard{display:none;}
    .history{display:none;}           /* ← oculto al inicio */
    .login-form input{padding:10px;margin:10px 0;width:100%;box-sizing:border-box;border-radius:5px;border:1px solid #ddd}
    .btn{background:#4CAF50;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer}
    .btn:hover{background:#45a049}
    #chart-container{width:100%;height:400px;margin-top:20px}
    canvas{margin-top:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    th{background:#f7f7f7}
  </style>
</head>
<body>
<div class="container">
  <!-- Login -->
  <div class="login-form">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"/>
    <input type="password" id="password" placeholder="Password"/>
    <button class="btn" onclick="login()">Login</button>
    <p id="login-error" style="color:red;display:none;">Invalid credentials.</p>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">
    <h2>ESP32 Data Dashboard</h2>
    <div>
      <h3>ESP32 1 (Temperatura y Humedad)</h3>
      <p id="temperature1">Loading...</p>
      <p id="humidity1">Loading...</p>
    </div>
    <div>
      <h3>ESP32 2 (Temperatura y Humedad)</h3>
      <p id="temperature2">Loading...</p>
      <p id="humidity2">Loading...</p>
    </div>
    <div id="chart-container">
      <canvas id="temperatureChart"></canvas>
      <canvas id="humidityChart"></canvas>
    </div>
    <button class="btn" onclick="showHistory()">Ver Datos Históricos</button>
  </div>

  <!-- Históricos -->
  <div class="history">
    <h2>Datos Históricos</h2>
    <input type="date" id="filter-date"/>
    <button class="btn" onclick="filterData()">Filtrar</button>
    <table id="data-table">
      <thead>
        <tr><th>Fecha</th><th>Temperatura</th><th>Humedad</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn" onclick="backToDashboard()">Volver</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC75WWrO1bkFQO_hFdt7pPoVd9UWW9d7II",
    authDomain: "proyectocalidad-7dd70.firebaseapp.com",
    databaseURL: "https://proyectocalidad-7dd70-default-rtdb.firebaseio.com",
    projectId: "proyectocalidad-7dd70",
    storageBucket: "proyectocalidad-7dd70.appspot.com",
    messagingSenderId: "342109623209",
    appId: "1:342109623209:web:b86ad030642a3330682ab8"
  };

  // Init (compat)
  const app = firebase.initializeApp(firebaseConfig);
  const db  = firebase.database();

  // ========= CAMBIA AQUÍ si guardas históricos en otra ruta =========
  const HISTORY_PATH = "/sensor-ESP1/history";
  // =================================================================

  // Estado
  let temperature1, humidity1, temperature2, humidity2;
  let temperatureChart, humidityChart;

  // Lee número tanto si el nodo es un número directo como si es {value: n}
  function readNumber(snapshot, key='value'){
    const v = snapshot.val();
    if (v == null) return null;
    if (typeof v === 'number') return v;
    if (typeof v === 'object' && v[key] != null) return v[key];
    return null;
  }

  function login(){
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if(u==='admin' && p==='admin'){
      document.querySelector('.login-form').style.display='none';
      document.querySelector('.dashboard').style.display='block';
      fetchData();
      initCharts();
    }else{
      document.getElementById('login-error').style.display='block';
    }
  }

  function initCharts(){
    const tctx = document.getElementById('temperatureChart').getContext('2d');
    temperatureChart = new Chart(tctx,{
      type:'line',
      data:{
        labels:['ESP32 1','ESP32 2'],
        datasets:[{label:'Temperature (°C)', data:[0,0], borderColor:'#FF5733', fill:false}]
      }
    });
    const hctx = document.getElementById('humidityChart').getContext('2d');
    humidityChart = new Chart(hctx,{
      type:'line',
      data:{
        labels:['ESP32 1','ESP32 2'],
        datasets:[{label:'Humidity (%)', data:[0,0], borderColor:'#33FF57', fill:false}]
      }
    });
  }

  // **RUTAS actualizadas a sensor-ESP1/ESP2**
  function fetchData(){
    db.ref('/sensor-ESP1/temperature').on('value', snap=>{
      temperature1 = readNumber(snap);
      if(temperature1!=null){
        document.getElementById('temperature1').innerText = "Temperature: "+temperature1+" °C";
        updateCharts();
      }
    });
    db.ref('/sensor-ESP1/humidity').on('value', snap=>{
      humidity1 = readNumber(snap);
      if(humidity1!=null){
        document.getElementById('humidity1').innerText = "Humidity: "+humidity1+" %";
        updateCharts();
      }
    });
    db.ref('/sensor-ESP2/temperature').on('value', snap=>{
      temperature2 = readNumber(snap);
      if(temperature2!=null){
        document.getElementById('temperature2').innerText = "Temperature: "+temperature2+" °C";
        updateCharts();
      }
    });
    db.ref('/sensor-ESP2/humidity').on('value', snap=>{
      humidity2 = readNumber(snap);
      if(humidity2!=null){
        document.getElementById('humidity2').innerText
