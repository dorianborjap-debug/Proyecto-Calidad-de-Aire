<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 Data Dashboard</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f4f9}
    .container{max-width:900px;margin:50px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1)}
    .login-form{display:block;}       /* ← visible al inicio */
    .dashboard{display:none;}
    .history{display:none;}           /* ← oculto al inicio */
    .login-form input{padding:10px;margin:10px 0;width:100%;box-sizing:border-box;border-radius:5px;border:1px solid #ddd}
    .btn{background:#4CAF50;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer}
    .btn:hover{background:#45a049}
    #chart-container{width:100%;height:400px;margin-top:20px}
    canvas{margin-top:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    th{background:#f7f7f7}
  </style>
</head>
<body>
<div class="container">
  <!-- Login -->
  <div class="login-form">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"/>
    <input type="password" id="password" placeholder="Password"/>
    <button class="btn" onclick="login()">Login</button>
    <p id="login-error" style="color:red;display:none;">Invalid credentials.</p>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">
    <h2>ESP32 Data Dashboard</h2>
    <div>
      <h3>ESP32 1 (Temperatura y Humedad)</h3>
      <p id="temperature1">Loading...</p>
      <p id="humidity1">Loading...</p>
    </div>
    <div>
      <h3>ESP32 2 (Temperatura y Humedad)</h3>
      <p id="temperature2">Loading...</p>
      <p id="humidity2">Loading...</p>
    </div>
    <div id="chart-container">
      <canvas id="temperatureChart"></canvas>
      <canvas id="humidityChart"></canvas>
    </div>
    <button class="btn" onclick="showHistory()">Ver Datos Históricos</button>
  </div>

  <!-- Históricos -->
  <div class="history">
    <h2>Datos Históricos</h2>
    <input type="date" id="filter-date"/>
    <button class="btn" onclick="filterData()">Filtrar</button>
    <table id="data-table">
      <thead>
        <tr><th>Fecha</th><th>Temperatura</th><th>Humedad</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn" onclick="backToDashboard()">Volver</button>
  </div>
</div>

<!-- SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // === CONFIG FIREBASE (bucket corregido) ===
  const firebaseConfig = {
    apiKey: "AIzaSyC75WWrO1bkFQO_hFdt7pPoVd9UWW9d7II",
    authDomain: "proyectocalidad-7dd70.firebaseapp.com",
    databaseURL: "https://proyectocalidad-7dd70-default-rtdb.firebaseio.com",
    projectId: "proyectocalidad-7dd70",
    storageBucket: "proyectocalidad-7dd70.appspot.com",
    messagingSenderId: "342109623209",
    appId: "1:342109623209:web:b86ad030642a3330682ab8"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db  = firebase.database();

  // === RUTAS ===
  const PATHS = {
    esp1: { temp: '/sensor-ESP1/temperature', hum: '/sensor-ESP1/humidity' },
    esp2: { temp: '/sensor-ESP2/temperature', hum: '/sensor-ESP2/humidity' }
  };

  // === ESTADO / CHARTS ===
  let temperature1, humidity1, temperature2, humidity2;
  let temperatureChart, humidityChart;

  // === HELPERS robustos ===
  function parseNum(x){
    if (x == null) return null;
    if (typeof x === 'number') return x;
    if (typeof x === 'string' && !isNaN(parseFloat(x))) return parseFloat(x);
    return null;
  }
  // Recibe el valor de un path que puede ser:
  //   - número directo
  //   - string numérico
  //   - objeto {value: n}
  //   - lista de hijos pushId -> {value: n, timestamp: t}
  function extractLatestValue(data, valueKey='value'){
    if (data == null) return null;
    const direct = parseNum(data);
    if (direct != null) return direct;
    if (typeof data === 'object'){
      if (data[valueKey] != null) return parseNum(data[valueKey]);
      const keys = Object.keys(data);
      if (!keys.length) return null;
      keys.sort();                         // push IDs ordenables
      const last = data[keys[keys.length-1]];
      if (last == null) return null;
      return parseNum(last) ?? parseNum(last[valueKey]);
    }
    return null;
  }
  // Suscribirse al ÚLTIMO valor de un path
  function watchLatest(path, cb, valueKey='value'){
    db.ref(path).on('value', snap=>{
      const v = extractLatestValue(snap.val(), valueKey);
      if (v != null) cb(v);
    });
  }

  // === LOGIN (igual que tenías) ===
  function login(){
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if(u==='admin' && p==='admin'){
      document.querySelector('.login-form').style.display='none';
      document.querySelector('.dashboard').style.display='block';
      fetchData();
      initCharts();
    }else{
      document.getElementById('login-error').style.display='block';
    }
  }

  // === CHARTS ===
  function initCharts(){
    const tctx = document.getElementById('temperatureChart').getContext('2d');
    temperatureChart = new Chart(tctx,{
      type:'line',
      data:{
        labels:['ESP32 1','ESP32 2'],
        datasets:[{label:'Temperature (°C)', data:[0,0], borderColor:'#FF5733', fill:false}]
      }
    });
    const hctx = document.getElementById('humidityChart').getContext('2d');
    humidityChart = new Chart(hctx,{
      type:'line',
      data:{
        labels:['ESP32 1','ESP32 2'],
        datasets:[{label:'Humidity (%)', data:[0,0], borderColor:'#33FF57', fill:false}]
      }
    });
  }
  function updateCharts(){
    if(temperatureChart && temperature1!=null && temperature2!=null){
      temperatureChart.data.datasets[0].data = [temperature1, temperature2];
      temperatureChart.update();
    }
    if(humidityChart && humidity1!=null && humidity2!=null){
      humidityChart.data.datasets[0].data = [humidity1, humidity2];
      humidityChart.update();
    }
  }

  // === LECTURA EN VIVO (usa el último hijo) ===
  function fetchData(){
    // ESP1
    watchLatest(PATHS.esp1.temp, v=>{
      temperature1 = v;
      document.getElementById('temperature1').innerText = "Temperature: "+v+" °C";
      updateCharts();
    });
    watchLatest(PATHS.esp1.hum, v=>{
      humidity1 = v;
      document.getElementById('humidity1').innerText = "Humidity: "+v+" %";
      updateCharts();
    });
    // ESP2
    watchLatest(PATHS.esp2.temp, v=>{
      temperature2 = v;
      document.getElementById('temperature2').innerText = "Temperature: "+v+" °C";
      updateCharts();
    });
    watchLatest(PATHS.esp2.hum, v=>{
      humidity2 = v;
      document.getElementById('humidity2').innerText = "Humidity: "+v+" %";
      updateCharts();
    });
  }

  // === HISTÓRICOS (ESP1): une temp y hum por timestamp ===
  function showHistory(){
    document.querySelector('.dashboard').style.display='none';
    document.querySelector('.history').style.display='block';
    fetchHistoricalData(); // últimos 100 por defecto
  }
  function backToDashboard(){
    document.querySelector('.history').style.display='none';
    document.querySelector('.dashboard').style.display='block';
  }

  // Obtiene rango por timestamp para una ruta
  function getRange(path, startSec, endSec, limit=100){
    let q = db.ref(path).orderByChild('timestamp');
    if (startSec != null) q = q.startAt(startSec);
    if (endSec   != null) q = q.endAt(endSec);
    return q.limitToLast(limit).once('value').then(s=>Object.values(s.val()||{}));
  }

  function fetchHistoricalData(){
    // últimos 100 registros de ESP1
    Promise.all([
      getRange(PATHS.esp1.temp, null, null, 100),
      getRange(PATHS.esp1.hum , null, null, 100)
    ]).then(([temps, hums])=>{
      renderJoinedTable(temps, hums);
    });
  }

  function filterData(){
    const d = document.getElementById('filter-date').value; // YYYY-MM-DD
    if(!d) return;
    const start = Math.floor(new Date(d+'T00:00:00').getTime()/1000);
    const end   = Math.floor(new Date(d+'T23:59:59').getTime()/1000);

    Promise.all([
      getRange(PATHS.esp1.temp, start, end, 500),
      getRange(PATHS.esp1.hum , start, end, 500)
    ]).then(([temps, hums])=>{
      renderJoinedTable(temps, hums);
    });
  }

  // Une por timestamp exacto y pinta la tabla
  function renderJoinedTable(temps, hums){
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';

    const map = new Map(); // ts -> {temp, hum}
    temps.forEach(r=>{
      if (r && r.timestamp!=null) {
        const ts = r.timestamp;
        const obj = map.get(ts) || {};
        obj.temp = parseNum(r.value);
        map.set(ts, obj);
      }
    });
    hums.forEach(r=>{
      if (r && r.timestamp!=null) {
        const ts = r.timestamp;
        const obj = map.get(ts) || {};
        obj.hum = parseNum(r.value);
        map.set(ts, obj);
      }
    });

    // ordenar por fecha desc
    const rows = Array.from(map.entries())
      .map(([ts, v]) => ({ ts, temp: v.temp, hum: v.hum }))
      .sort((a,b)=>b.ts - a.ts);

    if (!rows.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3">Sin datos</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      const date = new Date(r.ts*1000).toLocaleString();
      tr.innerHTML = `<td>${date}</td><td>${r.temp ?? '-'}</td><td>${r.hum ?? '-'}</td>`;
      tbody.appendChild(tr);
    });
  }
</script>
